# Спецификации требований

![Scheme 1][Scheme1]

## Описание системы

### Цели создания системы

- возможность быстрой оплаты за проезд
- сбор статистики о каждом автобусе на маршруте и общему пассажиропотоку
- сбор статистики о количестве средств на каждом автотранспортном средстве
- включение динамических тарифов оплаты

### Способы оплаты

- RFID карта
- Телефон с NFC чипом

### Виды карт

- Разовая - содержит счет владельца карты
- Временная - безлимитное использование до определенного срока 

### Компоненты проекта

- Server
- Transport
  + Rapberry PI
  + Arduino
  + RFID / NFC reader
- GPS
- Card receiving station
- Android / iOS application

### Содержимое RFID карты

| Блоки | Данные [размер в байтах] |
| :---: | :----------------------- |
| 0     | ID [4] |
| 4     | TYPE [1], EXPIRE_TIME [6] |
| 5     | LAST_TRANSPORT_ID [2], BALANCE [3], LAST_PAY_TIME [6] |

## Требования к структуре и функционированию Arduino

Функционал:

- работа с картой
  + считывает
    * данные с RFID карты / NFC метки
  + изменяет
    * данные на карте
- передача данных на Raspberry PI
  + о транзакциях (в момент транзакции)
- оповещение об ошибке при помощи сигнала (светового или звукового)

## Требования к структуре и функционированию RPi

Функционал:

- работа с Arduino
  + прием данных
    * о транзакции
    * о местоположении
  + обработка ошибок при оплате
    * невалидная карта
    * недостаточно средств (для разовых карт)
    * истек срок годности (для временных карт)
  + отправка команд на Arduino
    * о сигнализации об ошибке
    * для изменения данных на карте (при успешной оплате)
- работа с базами данных
  + сохранение транзакций
  + сохранение местоположения
- работа с главным сервером
  + проверка связи
  + отправка данных из базы
  + опрос главного сервера на наличие команд

## Требования к структуре и функционированию мобильного приложения

При разработке приложения нужно учесть следующие функции:

- Приобретение карт (максимум 2, т.к. видов карт всего 2)
- Выбор активной карты
- Денежная история

## Базы данных

### Общие таблицы

#### stations
Таблица описывает станции

| Столбец | Тип             | Описание |
| ------- | --------------- | -------- |
| id      | UNSIGNED INT(7) | id станции |
| name    | VARCHAR(255)    | название станции |
| type    | UNSIGNED INT(1) | id типа станции |
| latlng  | VARCHAR(50)     | координаты станции |

#### routes
Таблица описывает маршруты

| Столбец         | Тип             | Описание |
| --------------- | --------------- | -------- |
| id              | UNSIGNED INT(7) | id маршрута |
| name            | VARCHAR(45)     | название маршрута |
| type            | UNSIGNED INT(1) | id типа маршрута |
| payment_amount  | UNSIGNED INT(7) | стоимость проезда на этом маршруте |

#### transports
Таблица описывает транспортные средства

| Столбец         | Тип             | Описание |
| --------------- | --------------- | -------- |
| id              | UNSIGNED INT(7) | id транспорта |
| license_plate   | VARCHAR(20)     | регистрационный знак транспортного средства |
| type            | UNSIGNED INT(1) | id типа транспорта |

#### drivers
Таблица описывает водителей транспортных средств

| Столбец | Тип             | Описание |
| ------- | --------------- | -------- |
| id      | UNSIGNED INT(7) | id транспорта |
| name    | VARCHAR(255)    | Ф.И.О водителя |

#### routes_stations
Таблица описывает принадлежность станций маршрутам

| Столбец           | Тип               | Описание |
| ----------------- | ----------------- | -------- |
| id                | UNSIGNED INT(11)  | id связи |
| route_id          | UNSIGNED INT(7)   | id маршрута |
| station_id        | UNSIGNED INT(7)   | id станции |
| station_by_order  | UNSIGNED INT(3)   | порядковый номер станции на маршруте |

#### transports_routes
Таблица описывает принадлежность транспортных среств маршрутам

| Столбец       | Тип               | Описание |
| ------------- | ----------------- | -------- |
| id            | UNSIGNED INT(11)  | id связи |
| route_id      | UNSIGNED INT(7)   | id маршрута |
| transport_id  | UNSIGNED INT(7)   | id транспорта |
| time          | TIMESTAMP         | время назначения транспорта на маршрут |
| is_active     | UNSIGNED INT(1)   | находится ли данный транспорт на данном маршруте |

#### transports_drivers
Таблица описывает принадлежность водителей транспортным средствам

| Столбец       | Тип               | Описание |
| ------------- | ----------------- | -------- |
| id            | UNSIGNED INT(11)  | id связи |
| driver_id     | UNSIGNED INT(7)   | id водителя |
| transport_id  | UNSIGNED INT(7)   | id транспорта |
| time          | TIMESTAMP         | время назначения водителя транспорту |
| is_active     | UNSIGNED INT(1)   | находится ли данный водитель на данном транспорте |

#### transactions
Таблица описывает транзакции, которые были присланы с транспортного средства

| Столбец         | Тип               | Описание |
| --------------- | ----------------- | -------- |
| id              | UNSIGNED INT(11)  | id транзакции |
| transaction_id  | BINARY(16)        | uuid транзакции |
| time            | TIMESTAMP         | время транзакции |
| transport_id    | UNSIGNED INT(7)   | id транспорта, на котором была произведена транзакция |
| route_id        | UNSIGNED INT(7)   | id маршрута, на котором была произведена транзакция |
| station_id      | UNSIGNED INT(7)   | id станции, на которой была произведена транзакция |
| card_id         | UNSIGNED INT(10)  | id карты, с которой произошло списание средств |
| card_type       | UNSIGNED INT(2)   | id типа карты |
| payment_amount  | UNSIGNED INT(7)   | сумма списанная с карты |
| circle_number   | UNSIGNED INT(2)   | порядковый номер круга маршрута, на котором была произведена транзакция |

### Главный сервер

#### incoming_payments
Таблица описывает зачисления на транспортную карту, которые (зачисления) были произведены из пункта приема оплаты

| Столбец             | Тип               | Описание |
| ------------------- | ----------------- | -------- |
| id                  | BINARY(16)        | id зачисления |
| time                | TIMESTAMP         | время зачисления |
| card_id             | UNSIGNED INT(10)  | id карты, на которую было произведено зачисление |
| card_type           | UNSIGNED INT(2)   | id типа карты |
| payment_station_id  | UNSIGNED INT(7)   | id пункта оплаты |
| payment_amount      | UNSIGNED INT(7)   | сумма зачисления |

#### payment_stations
Таблица описывает пункт приема оплаты

| Столбец       | Тип             | Описание |
| ------------- | --------------- | -------- |
| id            | UNSIGNED INT(7) | id пункта |
| name          | VARCHAR(255)    | названия пукта |
| employee_name | VARCHAR(255)    | Ф.И.О. кассира пункта |

![Server_DB_scheme]

### База данных на Raspberry PI

### misc
Таблица хранит системные конфигурационные значения

| Столбец             | Тип               | Описание |
| ------------------- | ----------------- | -------- |
| current_station_id  | UNSIGNED INT(7)   | id текущей станции |
| last_sync_id        | UNSIGNED INT(11)  | id последней синхронизированной транзакции |
| circles_count       | UNSIGNED INT(2)   | количество пройденных кругов |

![Client_DB_scheme]

## Процесс оплаты за проезд с помощью RFID карты

1. Пассажир проводит картой возле NFC reader
2. NFC reader считывает все содержимое карты
3. Arduino передает данные на Raspberry PI
4. Проверяем данные с карты:
    - Проверка на корректность хеша
    - Проверка на тип карты:
      + Если временная, то проверка срока карты;
      + Если разовая, то проверка на наличие средств;
5. В зависимости от типа карты выполняем следующие действия:
    - Разовая:
      1. считываем деньги
      2. изменяем значение счета
      3. формируем новый хеш
    - Временная:
      1. обновляем дату последней оплаты
      2. формируем новый хеш
6. Отправляем команду на Arduino
    - Подтверждаем запись на карту
    - Сохраняем транзакцию в базе
7. Проверяем связь с сервером
    - при наличии связи передаем данные о транзакциях и о местоположении автобуса с привязкой по времени
    - ждем появления связи.


# Проектирование системы
## Общая картина

![Scheme 2][Scheme2]
![Scheme 3][Scheme3]
![Scheme 4][Scheme4]
![Scheme 5][Scheme5]

## Описание проблемы

![Scheme 6][Scheme6]

## Use Case Model

![Scheme 7][Scheme7]
![Scheme 8][Scheme8]

### Use Case “Оплата за проезд”
```
Название: Оплата за проезд
Краткое описание: Система принимает оплату за проезд
Актер: Пассажир
Зависимости: включает “Проверка” и “Сохранение местоположения”
Предусловие: Система находится в режиме ожидания, пока Пассажир не поднесет карту/смартфон
Основная последовательность:
 1. Пассажир подносит карту/смартфон к NFC-reader
 2. Если NFC-reader распознает, то система пробует считать карту
 3. Система проверяет валидность карты
 4. Система считывает тип карты
 5. Проверяем дату / счет на карте
 6. Обновляем данные на карте
 7. Сохранение транзакции в базе данных
 8. Оповещение об усп ешной транзакции Пассажира
Альтернативные последовательности:
 Шаг 2. Если NFC-reader не распознает карту, то далее он пытается повторно распознать ее.
 Шаг 3. Если карта не валидная, то оповещаем соответствующим сообщением и ожидаем следующую валидную.
 Шаг 5. Если карта типа разовой оплаты, то проверяем счет на карте.
 Шаг 5. Если карта временного типа, то проверяем дату истечения срока.
 Шаг 6. Если запись на карту не удалась, то оповещаем Пассажира и производим откат транзакции.
Постусловие: Пассажирская карта валидна и обновлена.
```
![Scheme activity_diagram_for_payment][activity_diagram_for_payment]

### Use Case “Синхронизация”
```
Название: Синхронизация
Краткое описание: RPi отправляет данные на сервер.
Актер: Система
Предусловие: RPi находится в режиме ожидания момента синхронизации.
Основная последовательность:
 1. RPi проверяет время.
 2. Если время пришло, то производится синхронизация.
 3. Проверяем наличие Интернет-соединения.
 4. Если Интернет-соединение имеется, то формируем пакет для отправки.
 5. Отправляем данные.
 6. Сохраняем время последней транзакции как метку для последующей отправки.
 7. Удаляем синхронизированные записи из базы данных.
Альтернативные последовательности:
 Шаг 2. Если время не пришло, то ожидаем далее.
 Шаг 4. Если Интернет-соединения нет, то ждем следующее время синхронизации.
 Шаг 5. Если отправка не удалась, то повторяем попытку.
Постусловие: Данные синхронизированы.
```

### Use Case “Определение местоположения”
```
Название: Определение местоположения
Краткое описание: RPi каждый промежуток времени определяет свое местоположение.
Актер: Система
Предусловие: RPi находится в режиме ожидания до момента времени определения местоположения.
Основная последовательность:
 1. RPi проверяет время.
 2. Если время пришло, то производится считывание присылаемых данных с GPS.
 3. Проверяем валидность данных.
 4. Если данные валидны, то производится проверка принадлежности координат той или иной остановке.
 5. Если координаты соответствуют какой-либо остановке, то определяем ее как текущую.
 6. Записываем это в базу.
Альтернативные послдовательности:
 Шаг 4. Если данные не валидны, то ждем валидных последующих присылаемых.
 Шаг 5. Если координаты не входят в какую-либо остановку, то отбрасываем пункт 6.
Постусловие: Местоположение и текущая остановка определены.
```
![Scheme activity diagram for GPS][activity_diagram_for_GPS]


### Use Case "Проверка оплаты"
```
Название: Проверка оплаты
Краткое описание: Производит проверку карты на наличие произведенной оплаты
Актер: Кондуктор
Зависимости: Нет
Предусловие: Имеется устройство проверки и карта, с которой только что была произведена оплата
Основная последовательность:
 1. Кондуктор подносит карту к устройству
 2. Устройство считывает данные с карты
 3. Устройство проверяет время и дату последней оплаты, которая записана на карте
 4. Устройство проверяет на соответствие идентификатор текущего транспорта (который зашит в устройство) и идентификатор транспорта записанный на карте
 5. Кондуктор возращает карту
Альтернативные последовательности:
 Шаг 3. В случае если оплата была произведена больше чем [ЛИМИТ] минут назад, то считается, что проезд не был оплачен
 Шаг 4. В случае если идентификаторы не совпадают, то считается, что проезд не был оплачен
Постусловие: Было проверено, что оплата действительно была совершена с данной карты
```

### Use Case "Получение данных с Raspberry PI"
```
Название: Получение данных с Raspberry PI
Краткое описание: Процесс получения данных с базы данных Raspberry PI для последующей загрузки на сервер
Актер: Кондуктор
Зависимости: Нет
Предусловие: На Raspberry PI есть данные, которые еще не синхронизированы с сервером
Основная последовательность:
 1. К Raspberry PI присоединяется съемный носитель
 2. Raspberry PI переходит в режим сервера с точкой доступа
 3. Кондуктор заходит на специальную страницу, указывает дату и нажимает на кнопку загрузить данные на съемный носитель
 4. Raspberry PI записывает данные с базы на съемный носитель ввиде запароленного архива (который знает Raspberry PI и сервер)
 5. Кондуктор вытаскивает съемный носитель
Альтернативные последовательности:
Постусловие: На съемный носитель записаны данные для синхронизации с сервером
```

### Use Case "Учет транспортных средств"
```
Название: Учет транспортных средств
Краткое описание: Внесение или изменение данных о транспортном средстве
Актер: Оператор
Зависимости: Нет
Предусловие: Есть данные о новом транспортном средстве или необходимо изменить данные о транспортном средстве
Основная последовательность:
 1. Оператор заходит на страницу администрации транспортных средств
 2. Оператор выбирает действие, которое нужно совершить
 3. Указывает государственный номер транспорта
 4. Выбирает из выданного списка номер маршрута
 5. Выбирает из выданного списка тип транспортного средства
 6. Выбирает из выданного списка водителя
Альтернативные последовательности:
 2. Если оператору нужно изменить уже существуюеще транспортное средство, то оператору предоставляется список занесенных транспортных средств, выбрав которое оператор может изменить данные
 2. Если оператору нужно внести новое транспортное средство, то оператору предоставляется пустая форма для заполнения
Постусловие: Данные о новом/уже существующем транспортном средстве были добавлены/изменены
```

### Use Case "Учет типов транспортных средств"
```
Название: Учет типов транспортных средств
Краткое описание: Внесение или изменение данных о типах транспортных средств
Актер: Оператор
Зависимости: Нет
Предусловие: Есть данные о новом типе транспортных средств или необходимо изменить данные о типе транспортных средств
Основная последовательность:
 1. Оператор заходит на страницу администрации типов транспортных средств
 2. Оператор выбирает действие, которое нужно совершить
 3. Указывает название типа транспортного средства
Альтернативные последовательности:
 2. Если оператору нужно изменить уже существуюещий тип транспортного средства, то оператору предоставляется список занесенных типов транспортных средств, выбрав которое оператор может изменить данные
 2. Если оператору нужно внести новый тип транспортного средства, то оператору предоставляется пустая форма для заполнения
Постусловие: Данные о новом/уже существующем типе транспортного средства были добавлены/изменены
```


### Use Case "Учет водителей"
```
Название: Учет водителей
Краткое описание: Внесение или изменение данных о водителях
Актер: Оператор
Зависимости: Нет
Предусловие: Есть данные о новом водителе или необходимо изменить данные о водителе
Основная последовательность:
 1. Оператор заходит на страницу администрации водителей
 2. Оператор выбирает действие, которое нужно совершить
 3. Указывает имя водителя
Альтернативные последовательности:
 2. Если оператору нужно изменить уже существуюещего водителя, то оператору предоставляется список занесенных водителей, выбрав которого оператор может изменить данные
 2. Если оператору нужно внести нового водителя, то оператору предоставляется пустая форма для заполнения
Постусловие: Данные о новом/уже существующем водителе были добавлены/изменены
```

### Use Case "Учет маршрутов"
```
Название: Учет маршрутов
Краткое описание: Внесение или изменение данных о маршрутах
Актер: Оператор
Зависимости: Нет
Предусловие: Есть данные о новом маршруте или необходимо изменить данные о маршруте
Основная последовательность:
 1. Оператор заходит на страницу администрации маршрутов
 2. Оператор выбирает действие, которое нужно совершить
 3. Указывает название маршрута
 4. Выбирает из выданного списка тип маршрута
Альтернативные последовательности:
 2. Если оператору нужно изменить уже существуюещий маршрут, то оператору предоставляется список занесенных маршрутов, выбрав которого оператор может изменить данные
 2. Если оператору нужно внести новый маршрут, то оператору предоставляется пустая форма для заполнения
Постусловие: Данные о новом/уже существующем маршруте были добавлены/изменены
```


### Use Case "Учет типов маршрутов"
```
Название: Учет типов маршрутов
Краткое описание: Внесение или изменение данных о типах маршрутов
Актер: Оператор
Зависимости: Нет
Предусловие: Есть данные о новом типе маршрута или необходимо изменить данные о типе маршрута
Основная последовательность:
 1. Оператор заходит на страницу администрации типов маршрутов
 2. Оператор выбирает действие, которое нужно совершить
 3. Указывает название типа маршрута
 4. Указывает стоимость проезда на этом маршруте
Альтернативные последовательности:
 2. Если оператору нужно изменить уже существуюещий тип маршрута, то оператору предоставляется список занесенных типов маршрутов, выбрав которое оператор может изменить данные
 2. Если оператору нужно внести новый тип маршрута, то оператору предоставляется пустая форма для заполнения
Постусловие: Данные о новом/уже существующем типе маршрута были добавлены/изменены
```


### Use Case "Учет станций"
```
Название: Учет станций
Краткое описание: Внесение или изменение данных о станциях
Актер: Оператор
Зависимости: Нет
Предусловие: Есть данные о новой станции или необходимо изменить данные о станции
Основная последовательность:
 1. Оператор заходит на страницу администрации станций
 2. Оператор выбирает действие, которое нужно совершить
 3. Указывает название станции
 4. Указывает местоположение станции
 5. Выбирает из выданного списка тип станции
Альтернативные последовательности:
 2. Если оператору нужно изменить уже существующую станцию, то оператору предоставляется список занесенных станций, выбрав которое оператор может изменить данные
 2. Если оператору нужно внести новую станцию, то оператору предоставляется пустая форма для заполнения
Постусловие: Данные о новой/уже существующей станции были добавлены/изменены
```

### Use Case "Учет типов станций"
```
Название: Учет типов станций
Краткое описание: Внесение или изменение данных о типах станций
Актер: Оператор
Зависимости: Нет
Предусловие: Есть данные о новом типе станции или необходимо изменить данные о типе станции
Основная последовательность:
 1. Оператор заходит на страницу администрации типов станций
 2. Оператор выбирает действие, которое нужно совершить
 3. Указывает название типа станции
Альтернативные последовательности:
 2. Если оператору нужно изменить уже существующий тип станции, то оператору предоставляется список занесенных типов станций, выбрав которое оператор может изменить данные
 2. Если оператору нужно внести новый тип станции, то оператору предоставляется пустая форма для заполнения
Постусловие: Данные о новом/уже существующем типе станции были добавлены/изменены
```


## Static Modeling
### Static Modeling of the Problem Domain

![Scheme conceptual_static_model_for_problem_domain][conceptual_static_model_for_problem_domain]

### Software system context class diagram for ITS

![Scheme context_class_diagram][context_class_diagram]

![Scheme context_class_diagram1][context_class_diagram1]

## Object Structuring

## Dynamic Modeling
### Диаграмма последовательностей для оплаты проезда

![Scheme 10][Scheme10]

### Диаграмма последовательностей для синхронизации

![Scheme 11][Scheme11]


## Диаграммы состояний
## Relational Database Design
## Detailed Design

![Scheme main_architecture][main_architecture]

![Scheme sd_card_bringing_vs_gps][sd_card_bringing_vs_gps]



[Scheme1]: schemes/1.png "Scheme1"
[Scheme2]: schemes/main_picture.png "Scheme2"
[Scheme3]: schemes/main_picture_transport.png "Scheme3"
[Scheme4]: schemes/main_picture_places.png "Scheme4"
[Scheme5]: schemes/main_picture_server.png "Scheme5"
[Scheme6]: schemes/problem_description.png "Scheme6"
[Scheme7]: schemes/use_case_model.png "Scheme7"
[Scheme8]: schemes/use_case_model0.png "Scheme8"
[activity_diagram_for_payment]: schemes/ad_payment.png "activity_diagram_for_payment"
[Scheme10]: schemes/sd_payment.png "Scheme10"
[Scheme11]: schemes/sd_synch.png "Scheme11"
[conceptual_static_model_for_problem_domain]: schemes/conceptual_static_model_for_problem_domain.png "conceptual_static_model_for_problem_domain"
[activity_diagram_for_GPS]: schemes/ad_latlng.png "activity_diagram_for_GPS"
[Server_DB_scheme]: schemes/database_server.png "Схема таблиц базы данных на сервере"
[Client_DB_scheme]: schemes/database_client.png "Схема таблиц базы данных на Rapberry PI"
[context_class_diagram]: schemes/context_class_diagram.png "context_class_diagram"
[context_class_diagram1]: schemes/context_class_diagram1.png "context_class_diagram1"
[main_architecture]: schemes/main_architecture.png "main_architecture"
[sd_card_bringing_vs_gps]: schemes/sd_card_bringing_vs_gps.png "sd_card_bringing_vs_gps"